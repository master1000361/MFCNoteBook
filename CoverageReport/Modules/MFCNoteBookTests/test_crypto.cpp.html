<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>test_crypto.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
// test_crypto.cpp - SHA1/AES ¼Ó½âÃÜ²âÊÔ
#include "pch.h"

using namespace TestableLogic;

// ============ SHA1 ²âÊÔ ============

<span style = "background-color:#dfd">TEST(CryptoTest, SHA1_EmptyString)
{
    BYTE hash[20] = { 0 };
    bool result = ComputeSHA1((const BYTE*)"", 0, hash, 20);</span>

<span style = "background-color:#dfd">    ASSERT_TRUE(result);</span>

    // ¿Õ×Ö·û´®µÄ SHA1: da39a3ee5e6b4b0d3255bfef95601890afd80709
<span style = "background-color:#dfd">    EXPECT_EQ(hash[0], 0xda);
    EXPECT_EQ(hash[1], 0x39);
    EXPECT_EQ(hash[19], 0x09);
}</span>

<span style = "background-color:#dfd">TEST(CryptoTest, SHA1_HelloWorld)
{
    const char* text = "Hello, World!";
    BYTE hash[20] = { 0 };</span>

<span style = "background-color:#dfd">    bool result = ComputeSHA1((const BYTE*)text, (DWORD)strlen(text), hash, 20);</span>

<span style = "background-color:#dfd">    ASSERT_TRUE(result);</span>
    // ÑéÖ¤¹þÏ£·ÇÈ«Áã
<span style = "background-color:#dfd">    bool allZero = true;
    for (int i = 0; i &lt; 20; i++)</span>
    {
<span style = "background-color:#dfd">        if (hash[i] != 0) allZero = false;
    }
    EXPECT_FALSE(allZero);
}</span>

<span style = "background-color:#dfd">TEST(CryptoTest, SHA1_BufferTooSmall)
{
    BYTE hash[10] = { 0 };  // Ì«Ð¡
    bool result = ComputeSHA1((const BYTE*)"test", 4, hash, 10);</span>

<span style = "background-color:#dfd">    EXPECT_FALSE(result);
}</span>

<span style = "background-color:#dfd">TEST(CryptoTest, SHA1_Consistency)
{</span>
    // ÏàÍ¬ÊäÈëÓ¦²úÉúÏàÍ¬¹þÏ£
<span style = "background-color:#dfd">    const char* text = "Test consistency";
    BYTE hash1[20] = { 0 };
    BYTE hash2[20] = { 0 };</span>

<span style = "background-color:#dfd">    ComputeSHA1((const BYTE*)text, (DWORD)strlen(text), hash1, 20);
    ComputeSHA1((const BYTE*)text, (DWORD)strlen(text), hash2, 20);</span>

<span style = "background-color:#dfd">    EXPECT_EQ(memcmp(hash1, hash2, 20), 0);
}</span>

// ============ AES ¼Ó½âÃÜ²âÊÔ ============

<span style = "background-color:#dfd">TEST(CryptoTest, AES_EncryptDecrypt_Basic)
{
    const char* plainText = "Hello, AES!";
    const char* key = "BIGC_AI_2025_KEY";
    BYTE iv[16] = { 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16 };</span>

<span style = "background-color:#dfd">    BYTE encrypted[64] = { 0 };
    DWORD encryptedLen = 64;</span>

<span style = "background-color:#dfd">    bool encResult = AESEncrypt(</span>
        (const BYTE*)plainText, (DWORD)strlen(plainText),
        (const BYTE*)key, (DWORD)strlen(key),
        iv, encrypted, encryptedLen);

<span style = "background-color:#dfd">    ASSERT_TRUE(encResult);
    EXPECT_GT(encryptedLen, 0u);</span>

    // ½âÃÜ
<span style = "background-color:#dfd">    BYTE decrypted[64] = { 0 };
    DWORD decryptedLen = encryptedLen;</span>

<span style = "background-color:#dfd">    bool decResult = AESDecrypt(</span>
        encrypted, encryptedLen,
        (const BYTE*)key, (DWORD)strlen(key),
        iv, decrypted, decryptedLen);

<span style = "background-color:#dfd">    ASSERT_TRUE(decResult);
    EXPECT_EQ(decryptedLen, strlen(plainText));
    EXPECT_EQ(memcmp(decrypted, plainText, decryptedLen), 0);
}</span>

<span style = "background-color:#dfd">TEST(CryptoTest, AES_DifferentIV_DifferentResult)
{
    const char* plainText = "Same text";
    const char* key = "BIGC_AI_2025_KEY";</span>

<span style = "background-color:#dfd">    BYTE iv1[16] = { 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 };
    BYTE iv2[16] = { 2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2 };</span>

<span style = "background-color:#dfd">    BYTE encrypted1[64] = { 0 };
    BYTE encrypted2[64] = { 0 };
    DWORD len1 = 64, len2 = 64;</span>

<span style = "background-color:#dfd">    AESEncrypt((const BYTE*)plainText, (DWORD)strlen(plainText),</span>
        (const BYTE*)key, (DWORD)strlen(key), iv1, encrypted1, len1);
<span style = "background-color:#dfd">    AESEncrypt((const BYTE*)plainText, (DWORD)strlen(plainText),</span>
        (const BYTE*)key, (DWORD)strlen(key), iv2, encrypted2, len2);

    // ²»Í¬ IV Ó¦²úÉú²»Í¬ÃÜÎÄ
<span style = "background-color:#dfd">    EXPECT_NE(memcmp(encrypted1, encrypted2, len1), 0);
}</span>

<span style = "background-color:#dfd">TEST(CryptoTest, GenerateRandomIV_NotAllZero)
{
    BYTE iv[16] = { 0 };
    bool result = GenerateRandomIV(iv, 16);</span>

<span style = "background-color:#dfd">    ASSERT_TRUE(result);</span>

<span style = "background-color:#dfd">    bool allZero = true;
    for (int i = 0; i &lt; 16; i++)</span>
    {
<span style = "background-color:#dfd">        if (iv[i] != 0) allZero = false;
    }
    EXPECT_FALSE(allZero);
}</span>

<span style = "background-color:#dfd">TEST(CryptoTest, GenerateRandomIV_Unique)
{
    BYTE iv1[16] = { 0 };
    BYTE iv2[16] = { 0 };</span>

<span style = "background-color:#dfd">    GenerateRandomIV(iv1, 16);
    GenerateRandomIV(iv2, 16);</span>

    // Á½´ÎÉú³ÉÓ¦¸Ã²»Í¬
<span style = "background-color:#dfd">    EXPECT_NE(memcmp(iv1, iv2, 16), 0);
}</span>

<span style = "background-color:#dfd">TEST(CryptoTest, VerifyIntegrity_Match)
{
    BYTE hash1[20] = { 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20 };
    BYTE hash2[20] = { 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20 };</span>

<span style = "background-color:#dfd">    EXPECT_TRUE(VerifyIntegrity(hash1, hash2, 20));
}</span>

<span style = "background-color:#dfd">TEST(CryptoTest, VerifyIntegrity_Mismatch)
{
    BYTE hash1[20] = { 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20 };
    BYTE hash2[20] = { 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,99 };</span>

<span style = "background-color:#dfd">    EXPECT_FALSE(VerifyIntegrity(hash1, hash2, 20));
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>